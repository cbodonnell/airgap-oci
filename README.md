# Airgap OCI Bundle

This repo contains resources from initial investigations into how airgap bundles can be stored as OCI artifacts.

## Dependencies

[docker](https://docs.docker.com/get-docker/) - used to run a local registries for this example.
[oras](https://github.com/oras-project/oras) - an OCI client for managing content like artifacts, images, packages. It can be used to create an OCI artifact from a directory of files.
[skopeo](https://github.com/containers/skopeo) - a tool for working with remote registries. It can be used to copy images from one registry to another.
[go](https://golang.org/doc/install) (optional) - used to generate the `scripts/artifact.sh` script.

## Creating an Airgap Bundle OCI artifact

Today, an airgap bundle consists of three main components:
* `airgap.yaml` - airgap metadata
* `app.tar.gz` - application bundle
* `images` - directory containing a registry of images

In this example, we will assume we already have the `airgap.yaml` and `app.tar.gz` files and we will use `skopeo` to copy the images from a remote registry to a temporary local registry to use for the bundle.

### Create a local registry

Start a local registry on port 5000 and store the registry data in the `bundle/images` directory.

```bash
docker run -d -p 5000:5000 -v $(PWD)/bundle/images:/var/lib/registry --name bundle-registry registry:2
```

### Copy images to the local registry

Copy the images to the local registry. The `--preserve-digests` flag will ensure that the image digests are not changed when they are copied to the local registry. The `--multi-arch all` flag will ensure that all of the image's architectures are copied to the local registry. We're copying two images in this example to demonstrate deduplication of layers.

```bash
skopeo copy --dest-tls-verify=false --preserve-digests --multi-arch all docker://docker.io/library/postgres:15.5-alpine docker://localhost:5000/postgres:15.5-alpine
skopeo copy --dest-tls-verify=false --preserve-digests --multi-arch all docker://docker.io/library/postgres:16.1-alpine docker://localhost:5000/postgres:16.1-alpine
```

### Create an OCI artifact

In this step we'll start up another registry on port 5001, but this could be any registry where the airgap bundle will be stored, such as the Replicated Registry.

```bash
docker run -d -p 5001:5000 -v $(PWD)/bundle/images:/var/lib/registry --name storage-registry registry:2
```

It's not necessary to login to the registry in this example, but if it was required, it could be done with the following command:

```bash
oras login localhost:5001 -u $USERNAME -p $PASSWORD
```

The `scripts/artifact.sh` script uses `oras push` to create an OCI artifact that has a custom artifact type of `application/vnd.airgap.bundle`.This artifact will have layers for the metadata, application bundle, and images. Each image blob will be stored as separate layer in the artifact to leverage the deduplication of the OCI format. This script can be regenerated by running `go run ./cmd/main.go`, if necessary.

```bash
./scripts/artifact.sh
```

To fetch the manifest for the uploaded artifact, run:

```bash
oras manifest fetch localhost:5001/my-company/airgap-bundle:v1
```

## Downloading an Airgap Bundle OCI artifact

This section provides an example of how an end-user could download an airgap bundle OCI artifact.

### Pulling an artifact

For this example, let's go to a clean working directory:
  
```bash
cd $(mktemp -d)
```

As before, it's not necessary to login to the registry in this example, but if it was required, it could be done with the following command:

```bash
oras login localhost:5001 -u $USERNAME -p $PASSWORD
```

To download an artifact, run:

```bash
oras pull localhost:5001/my-company/airgap-bundle:v1
```

This will download the artifact to the current directory. The artifact will be stored in the `bundle` directory. The `bundle` directory will contain all of the files that were uploaded to the artifact, including the `airgap.yaml` and `app.tar.gz` files, as well as the `images` directory containing the images that were copied to the local registry.

### Checksums

An OCI image has a manifest that contains a list of layers. Each layer has a digest that is a checksum of the layer's contents. The manifest also has a digest that is a checksum of the manifest's contents. The manifest digest is used to reference the image. OCI clients use these digests to verify the integrity of the image.

To compute digest of the manifest, run:

```bash
oras manifest fetch localhost:5001/my-company/airgap-bundle:v1 | shasum -a 256
```

To pull an artifact using the manifest digest, run:

```bash
oras pull localhost:5001/my-company/airgap-bundle@sha256:${SHA256SUM}
```

If desired, the checksums of the files returned can be validated against the checksums of the layers in the manifest:

```bash
shasum -a 256 bundle/*
shasum -a 256 bundle/images/docker/registry/v2/blobs/sha256/*/*/data
```

## Additional Resources

* https://github.com/opencontainers/image-spec/blob/main/manifest.md#guidelines-for-artifact-usage
* https://oras.land/docs/
* https://www.youtube.com/watch?v=XbUAPlZi0x0
* https://dlorenc.medium.com/oci-artifacts-explained-8f4a77945c13
* https://explore.ggcr.dev/
